{"version":3,"sources":["websocket.js"],"names":[],"mappings":"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","file":"websocket-compiled.js","sourcesContent":["/**\n * Module dependencies.\n */\n\nvar Transport = require('../transport');\nvar parser = require('engine.io-parser');\nvar parseqs = require('parseqs');\nvar inherit = require('component-inherit');\nvar yeast = require('yeast');\nvar debug = require('debug')('engine.io-client:websocket');\nvar BrowserWebSocket = global.WebSocket || global.MozWebSocket;\n\n/**\n * Get either the `WebSocket` or `MozWebSocket` globals\n * in the browser or try to resolve WebSocket-compatible\n * interface exposed by `ws` for Node-like environment.\n */\n\nvar WebSocket = BrowserWebSocket;\nif (!WebSocket && typeof window === 'undefined') {\n  try {\n    WebSocket = require('ws');\n  } catch (e) { }\n}\n\n/**\n * Module exports.\n */\n\nmodule.exports = WS;\n\n/**\n * WebSocket transport constructor.\n *\n * @api {Object} connection options\n * @api public\n */\n\nfunction WS (opts) {\n  var forceBase64 = (opts && opts.forceBase64);\n  if (forceBase64) {\n    this.supportsBinary = false;\n  }\n  this.perMessageDeflate = opts.perMessageDeflate;\n  Transport.call(this, opts);\n}\n\n/**\n * Inherits from Transport.\n */\n\ninherit(WS, Transport);\n\n/**\n * Transport name.\n *\n * @api public\n */\n\nWS.prototype.name = 'websocket';\n\n/*\n * WebSockets support binary\n */\n\nWS.prototype.supportsBinary = true;\n\n/**\n * Opens socket.\n *\n * @api private\n */\n\nWS.prototype.doOpen = function () {\n  if (!this.check()) {\n    // let probe timeout\n    return;\n  }\n\n  var uri = this.uri();\n  var protocols = void (0);\n  var opts = {\n    agent: this.agent,\n    perMessageDeflate: this.perMessageDeflate\n  };\n\n  // SSL options for Node.js client\n  opts.pfx = this.pfx;\n  opts.key = this.key;\n  opts.passphrase = this.passphrase;\n  opts.cert = this.cert;\n  opts.ca = this.ca;\n  opts.ciphers = this.ciphers;\n  opts.rejectUnauthorized = this.rejectUnauthorized;\n  if (this.extraHeaders) {\n    opts.headers = this.extraHeaders;\n  }\n\n  try {\n    this.ws = BrowserWebSocket ? new WebSocket(uri) : new WebSocket(uri, protocols, opts);\n  } catch (err) {\n    return this.emit('error', err);\n  }\n\n  if (this.ws.binaryType === undefined) {\n    this.supportsBinary = false;\n  }\n\n  if (this.ws.supports && this.ws.supports.binary) {\n    this.supportsBinary = true;\n    this.ws.binaryType = 'nodebuffer';\n  } else {\n    this.ws.binaryType = 'arraybuffer';\n  }\n\n  this.addEventListeners();\n};\n\n/**\n * Adds event listeners to the socket\n *\n * @api private\n */\n\nWS.prototype.addEventListeners = function () {\n  var self = this;\n\n  this.ws.onopen = function () {\n    self.onOpen();\n  };\n  this.ws.onclose = function () {\n    self.onClose();\n  };\n  this.ws.onmessage = function (ev) {\n    self.onData(ev.data);\n  };\n  this.ws.onerror = function (e) {\n    self.onError('websocket error', e);\n  };\n};\n\n/**\n * Writes data to socket.\n *\n * @param {Array} array of packets.\n * @api private\n */\n\nWS.prototype.write = function (packets) {\n  var self = this;\n  this.writable = false;\n\n  // encodePacket efficient as it uses WS framing\n  // no need for encodePayload\n  var total = packets.length;\n  for (var i = 0, l = total; i < l; i++) {\n    (function (packet) {\n      parser.encodePacket(packet, self.supportsBinary, function (data) {\n        if (!BrowserWebSocket) {\n          // always create a new object (GH-437)\n          var opts = {};\n          if (packet.options) {\n            opts.compress = packet.options.compress;\n          }\n\n          if (self.perMessageDeflate) {\n            var len = 'string' === typeof data ? global.Buffer.byteLength(data) : data.length;\n            if (len < self.perMessageDeflate.threshold) {\n              opts.compress = false;\n            }\n          }\n        }\n\n        // Sometimes the websocket has already been closed but the browser didn't\n        // have a chance of informing us about it yet, in that case send will\n        // throw an error\n        try {\n          if (BrowserWebSocket) {\n            // TypeError is thrown when passing the second argument on Safari\n            self.ws.send(data);\n          } else {\n            self.ws.send(data, opts);\n          }\n        } catch (e) {\n          debug('websocket closed before onclose event');\n        }\n\n        --total || done();\n      });\n    })(packets[i]);\n  }\n\n  function done () {\n    self.emit('flush');\n\n    // fake drain\n    // defer to next tick to allow Socket to clear writeBuffer\n    setTimeout(function () {\n      self.writable = true;\n      self.emit('drain');\n    }, 0);\n  }\n};\n\n/**\n * Called upon close\n *\n * @api private\n */\n\nWS.prototype.onClose = function () {\n  Transport.prototype.onClose.call(this);\n};\n\n/**\n * Closes socket.\n *\n * @api private\n */\n\nWS.prototype.doClose = function () {\n  if (typeof this.ws !== 'undefined') {\n    this.ws.close();\n  }\n};\n\n/**\n * Generates uri for connection.\n *\n * @api private\n */\n\nWS.prototype.uri = function () {\n  var query = this.query || {};\n  var schema = this.secure ? 'wss' : 'ws';\n  var port = '';\n\n  // avoid port if default for schema\n  if (this.port && (('wss' === schema && this.port !== 443) ||\n    ('ws' === schema && this.port !== 80))) {\n    port = ':' + this.port;\n  }\n\n  // append timestamp to URI\n  if (this.timestampRequests) {\n    query[this.timestampParam] = yeast();\n  }\n\n  // communicate binary support capabilities\n  if (!this.supportsBinary) {\n    query.b64 = 1;\n  }\n\n  query = parseqs.encode(query);\n\n  // prepend ? to query\n  if (query.length) {\n    query = '?' + query;\n  }\n\n  var ipv6 = this.hostname.indexOf(':') !== -1;\n  return schema + '://' + (ipv6 ? '[' + this.hostname + ']' : this.hostname) + port + this.path + query;\n};\n\n/**\n * Feature detection for WebSocket.\n *\n * @return {Boolean} whether this transport is available.\n * @api public\n */\n\nWS.prototype.check = function () {\n  return !!WebSocket && !('__initialize' in WebSocket && this.name === WS.prototype.name);\n};\n"]}