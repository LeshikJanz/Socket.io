{"version":3,"sources":["polling.js"],"names":[],"mappings":"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","file":"polling-compiled.js","sourcesContent":["\n/**\n * Module requirements.\n */\n\nvar Transport = require('../transport')\n  , parser = require('engine.io-parser')\n  , zlib = require('zlib')\n  , accepts = require('accepts')\n  , debug = require('debug')('engine:polling');\n\nvar compressionMethods = {\n  gzip: zlib.createGzip,\n  deflate: zlib.createDeflate\n};\n\n/**\n * Exports the constructor.\n */\n\nmodule.exports = Polling;\n\n/**\n * HTTP polling constructor.\n *\n * @api public.\n */\n\nfunction Polling (req) {\n  Transport.call(this, req);\n\n  this.closeTimeout = 30 * 1000;\n  this.maxHttpBufferSize = null;\n  this.httpCompression = null;\n}\n\n/**\n * Inherits from Transport.\n *\n * @api public.\n */\n\nPolling.prototype.__proto__ = Transport.prototype;\n\n/**\n * Transport name\n *\n * @api public\n */\n\nPolling.prototype.name = 'polling';\n\n/**\n * Overrides onRequest.\n *\n * @param {http.ServerRequest}\n * @api private\n */\n\nPolling.prototype.onRequest = function (req) {\n  var res = req.res;\n\n  if ('GET' == req.method) {\n    this.onPollRequest(req, res);\n  } else if ('POST' == req.method) {\n    this.onDataRequest(req, res);\n  } else {\n    res.writeHead(500);\n    res.end();\n  }\n};\n\n/**\n * The client sends a request awaiting for us to send data.\n *\n * @api private\n */\n\nPolling.prototype.onPollRequest = function (req, res) {\n  if (this.req) {\n    debug('request overlap');\n    // assert: this.res, '.req and .res should be (un)set together'\n    this.onError('overlap from client');\n    res.writeHead(500);\n    res.end();\n    return;\n  }\n\n  debug('setting request');\n\n  this.req = req;\n  this.res = res;\n\n  var self = this;\n\n  function onClose () {\n    self.onError('poll connection closed prematurely');\n  }\n\n  function cleanup () {\n    req.removeListener('close', onClose);\n    self.req = self.res = null;\n  }\n\n  req.cleanup = cleanup;\n  req.on('close', onClose);\n\n  this.writable = true;\n  this.emit('drain');\n\n  // if we're still writable but had a pending close, trigger an empty send\n  if (this.writable && this.shouldClose) {\n    debug('triggering empty send to append close packet');\n    this.send([{ type: 'noop' }]);\n  }\n};\n\n/**\n * The client sends a request with data.\n *\n * @api private\n */\n\nPolling.prototype.onDataRequest = function (req, res) {\n  if (this.dataReq) {\n    // assert: this.dataRes, '.dataReq and .dataRes should be (un)set together'\n    this.onError('data request overlap from client');\n    res.writeHead(500);\n    res.end();\n    return;\n  }\n\n  var isBinary = 'application/octet-stream' == req.headers['content-type'];\n\n  this.dataReq = req;\n  this.dataRes = res;\n\n  var chunks = isBinary ? new Buffer(0) : '';\n  var self = this;\n\n  function cleanup () {\n    chunks = isBinary ? new Buffer(0) : '';\n    req.removeListener('data', onData);\n    req.removeListener('end', onEnd);\n    req.removeListener('close', onClose);\n    self.dataReq = self.dataRes = null;\n  }\n\n  function onClose () {\n    cleanup();\n    self.onError('data request connection closed prematurely');\n  }\n\n  function onData (data) {\n    var contentLength;\n    if (typeof data == 'string') {\n      chunks += data;\n      contentLength = Buffer.byteLength(chunks);\n    } else {\n      chunks = Buffer.concat([chunks, data]);\n      contentLength = chunks.length;\n    }\n\n    if (contentLength > self.maxHttpBufferSize) {\n      chunks = '';\n      req.connection.destroy();\n    }\n  }\n\n  function onEnd () {\n    self.onData(chunks);\n\n    var headers = {\n      // text/html is required instead of text/plain to avoid an\n      // unwanted download dialog on certain user-agents (GH-43)\n      'Content-Type': 'text/html',\n      'Content-Length': 2\n    };\n\n    res.writeHead(200, self.headers(req, headers));\n    res.end('ok');\n    cleanup();\n  }\n\n  req.on('close', onClose);\n  if (!isBinary) req.setEncoding('utf8');\n  req.on('data', onData);\n  req.on('end', onEnd);\n};\n\n/**\n * Processes the incoming data payload.\n *\n * @param {String} encoded payload\n * @api private\n */\n\nPolling.prototype.onData = function (data) {\n  debug('received \"%s\"', data);\n  var self = this;\n  var callback = function(packet) {\n    if ('close' == packet.type) {\n      debug('got xhr close packet');\n      self.onClose();\n      return false;\n    }\n\n    self.onPacket(packet);\n  };\n\n  parser.decodePayload(data, callback);\n};\n\n/**\n * Overrides onClose.\n *\n * @api private\n */\n\nPolling.prototype.onClose = function () {\n  if (this.writable) {\n    // close pending poll request\n    this.send([{ type: 'noop' }]);\n  }\n  Transport.prototype.onClose.call(this);\n};\n\n/**\n * Writes a packet payload.\n *\n * @param {Object} packet\n * @api private\n */\n\nPolling.prototype.send = function (packets) {\n  this.writable = false;\n\n  if (this.shouldClose) {\n    debug('appending close packet to payload');\n    packets.push({ type: 'close' });\n    this.shouldClose();\n    this.shouldClose = null;\n  }\n\n  var self = this;\n  parser.encodePayload(packets, this.supportsBinary, function(data) {\n    var compress = packets.some(function(packet) {\n      return packet.options && packet.options.compress;\n    });\n    self.write(data, { compress: compress });\n  });\n};\n\n/**\n * Writes data as response to poll request.\n *\n * @param {String} data\n * @param {Object} options\n * @api private\n */\n\nPolling.prototype.write = function (data, options) {\n  debug('writing \"%s\"', data);\n  var self = this;\n  this.doWrite(data, options, function() {\n    self.req.cleanup();\n  });\n};\n\n/**\n * Performs the write.\n *\n * @api private\n */\n\nPolling.prototype.doWrite = function (data, options, callback) {\n  var self = this;\n\n  // explicit UTF-8 is required for pages not served under utf\n  var isString = typeof data == 'string';\n  var contentType = isString\n    ? 'text/plain; charset=UTF-8'\n    : 'application/octet-stream';\n\n  var headers = {\n    'Content-Type': contentType\n  };\n\n  if (!this.httpCompression || !options.compress) {\n    respond(data);\n    return;\n  }\n\n  var len = isString ? Buffer.byteLength(data) : data.length;\n  if (len < this.httpCompression.threshold) {\n    respond(data);\n    return;\n  }\n\n  var encoding = accepts(this.req).encodings(['gzip', 'deflate']);\n  if (!encoding) {\n    respond(data);\n    return;\n  }\n\n  this.compress(data, encoding, function(err, data) {\n    if (err) {\n      self.res.writeHead(500);\n      self.res.end();\n      callback(err);\n      return;\n    }\n\n    headers['Content-Encoding'] = encoding;\n    respond(data);\n  });\n\n  function respond(data) {\n    headers['Content-Length'] = 'string' == typeof data ? Buffer.byteLength(data) : data.length;\n    self.res.writeHead(200, self.headers(self.req, headers));\n    self.res.end(data);\n    callback();\n  }\n};\n\n/**\n * Comparesses data.\n *\n * @api private\n */\n\nPolling.prototype.compress = function (data, encoding, callback) {\n  debug('compressing');\n\n  var buffers = [];\n  var nread = 0;\n\n  compressionMethods[encoding](this.httpCompression)\n    .on('error', callback)\n    .on('data', function(chunk) {\n      buffers.push(chunk);\n      nread += chunk.length;\n    })\n    .on('end', function() {\n      callback(null, Buffer.concat(buffers, nread));\n    })\n    .end(data);\n};\n\n/**\n * Closes the transport.\n *\n * @api private\n */\n\nPolling.prototype.doClose = function (fn) {\n  debug('closing');\n\n  var self = this;\n  var closeTimeoutTimer;\n\n  if (this.dataReq) {\n    debug('aborting ongoing data request');\n    this.dataReq.destroy();\n  }\n\n  if (this.writable) {\n    debug('transport writable - closing right away');\n    this.send([{ type: 'close' }]);\n    onClose();\n  } else if (this.discarded) {\n    debug('transport discarded - closing right away');\n    onClose();\n  } else {\n    debug('transport not writable - buffering orderly close');\n    this.shouldClose = onClose;\n    closeTimeoutTimer = setTimeout(onClose, this.closeTimeout);\n  }\n\n  function onClose() {\n    clearTimeout(closeTimeoutTimer);\n    fn();\n    self.onClose();\n  }\n};\n\n/**\n * Returns headers for a response.\n *\n * @param {http.ServerRequest} request\n * @param {Object} extra headers\n * @api private\n */\n\nPolling.prototype.headers = function (req, headers) {\n  headers = headers || {};\n\n  // prevent XSS warnings on IE\n  // https://github.com/LearnBoost/socket.io/pull/1333\n  var ua = req.headers['user-agent'];\n  if (ua && (~ua.indexOf(';MSIE') || ~ua.indexOf('Trident/'))) {\n    headers['X-XSS-Protection'] = '0';\n  }\n\n  this.emit('headers', headers);\n  return headers;\n};\n"]}